name: Validar nombres de commits

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validar-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Obtener commits del PR
        run: |
          echo "üîç Validando commits del Pull Request..."

          COMMITS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits" \
            | jq -r '.[].commit.message')

          REGEX='^(feature-S|bugfix-|hotfix-).+'
          INVALID=0

          echo "‚úÖ Prefijos v√°lidos: feature-, bugfix-, hotfix-"

          echo "$COMMITS" | while read -r COMMIT_MSG; do
            echo "üìù Validando: '$COMMIT_MSG'"
            if [[ ! "$COMMIT_MSG" =~ $REGEX ]]; then
              echo "::error ::‚ùå Commit inv√°lido: '$COMMIT_MSG'"
              echo "::error ::El mensaje debe comenzar con uno de los siguientes prefijos: feature-, bugfix-, hotfix-"
              INVALID=1
            fi
          done

          if [[ "$INVALID" -eq 1 ]]; then
            echo "::error ::‚ùå Uno o m√°s commits tienen nombres inv√°lidos. Corrige los mensajes antes de continuar."
            exit 1
          fi
